function I(q){const A=F(q),J=j(q),V=g(J,A);for(let K=0;K<J;++K)for(let Z=0;Z<A;++Z)V[Z][K]=q[J-K-1][Z];return V}var w=function(q){const A=F(q),J=j(q);let V=0;for(let K=0;K<A;++K){let Z=!1;for(let Q=J-1;Q>=0;--Q){const _=q[Q][K];if(Z&&_===".")++V;else if(_!==".")Z=!0}}return V},R=function(q,A,J,V){const K=F(J),Z=j(J);for(let Q=0;Q<K;++Q)for(let _=0;_<Z;++_){if(J[_][Q]===".")continue;if(V[_+A]?.[Q+q]!==".")return!0}return!1},m=function(q,A,J,V){if(R(q,A,J,V))return;for(let K=q-1;K>=0;--K){if(R(K,A,J,V))break;q=K}return{x:q,y:A}},x=function(q,A,J,V){if(R(q,A,J,V))return;for(let K=A-1;K>=0;--K){if(R(q,K,J,V))break;A=K}return{x:q,y:A}},c=function(q,A,J,V){const K=D(V);for(let Z=0;Z<F(J);++Z)for(let Q=0;Q<j(J);++Q){const _=J[Q][Z];if(_!==".")K[Q+A][Z+q]=_}return K},b=function(q,A){const J=F(A),V=j(A),K=W[q];let Z=A,Q=!1,_=J*V,$=y(K.tiles);for(let O=0;O<K.numRotations;++O){const H=F($),X=j($);for(let N=0;N<=J-H;++N){let T=x(N,V-X,$,A);if(!T)continue;if(T=m(T.x,T.y,$,A),!T)continue;const Y=c(T.x,T.y,$,A),L=w(Y);if(L<_)_=L,Z=Y,Q=!0}$=I($)}return Q?{board:Z,shapeIndex:q}:void 0};function v(q,A,J=[]){let V=g(q,A);if(!J.length)J=new Array(q*(A-2)).fill(0).map(()=>S(W));const K=[];return J.forEach((Z)=>{const Q=b(Z,V);if(Q)V=Q.board,K.push(Q.shapeIndex)}),{board:V,shapes:K.sort()}}var W=[{numRotations:1,tiles:[["a","a"],["a","a"]]},{numRotations:2,tiles:[[".","b","."],[".","b","."],[".","b","."],[".","b","."]]},{numRotations:3,tiles:[["c","."],["c","c"],[".","c"]]},{numRotations:3,tiles:[[".","d"],["d","d"],["d","."]]},{numRotations:4,tiles:[["e","e","."],[".","e","."],[".","e","."]]},{numRotations:4,tiles:[[".","f","f"],[".","f","."],[".","f","."]]},{numRotations:4,tiles:[[".","g","."],[".","g","g"],[".","g","."]]}],F=(q)=>q[0].length,j=(q)=>q.length,D=(q)=>q.map((A)=>A.map((J)=>J)),g=(q,A)=>new Array(A).fill(null).map(()=>new Array(q).fill(".")),E=(q,A)=>Math.floor(Math.random()*(A-q))+q,S=(q)=>E(0,q.length),y=(q)=>{q=D(q);while(q.every((A)=>A[0]==="."))q=q.map((A)=>A.slice(1));while(q.every((A)=>A[A.length-1]==="."))q=q.map((A)=>A.slice(0,-1));return q};var n=function(q){k=q,localStorage.setItem("blockfit.mode",q),location.hash=u()},P=function(q,A,J,V){return q.addEventListener(A,J,V),()=>q.removeEventListener(A,J,V)},p=function(){const q=document.createElement("game-block");q.style.visibility="hidden",document.body.append(q);const A=q.getBoundingClientRect();return q.remove(),A},f=function(q,A){const J=j(q),V=F(q),K=[0,0];let Z=[-4,V+1];return A.forEach((Q,_)=>{const $=_%K.length;if(Q.move(Z[$],K[$]),K[$]+=j(Q.tiles)+1,K[$]>J+6)K[$]=J+1,Z=[0,V-F(Q.tiles)]}),A},r=function({shapes:q,board:A}){return f(A,q.map((J)=>{return new z(J)}))},h=function(q){const A=document.createElement("game-board");return A.style.setProperty("--height",`${q.length}`),A.style.setProperty("--width",`${q[0].length}`),q.forEach((J,V)=>{J.forEach((K,Z)=>{if(K===".")return;const Q=document.createElement("game-slot");Q.style.setProperty("--x",`${Z}`),Q.style.setProperty("--y",`${V}`),A.append(Q)})}),A},d=function(q,A){const J=q.tiles,V=F(J),K=j(J),Z=q.x,Q=q.y;return A.some((_)=>{if(_===q)return!1;for(let $=0;$<V;++$)for(let O=0;O<K;++O){if(J[O][$]===".")continue;const H=$+Z-_.x,X=O+Q-_.y,N=_.tiles[X]?.[H];if(N&&N!==".")return!0}})},i=function(q,A){const J=D(q.tiles);return A.every((V)=>{const K=j(V.tiles),Z=F(V.tiles);for(let Q=0;Q<K;++Q)for(let _=0;_<Z;++_){const $=V.tiles[Q][_];if($===".")continue;const O=_+V.x,H=Q+V.y;if(J[H]?.[O]!==".")return!1;J[H][O]=$}return!0})},u=function(){const[q,A]=B[k](),{board:J,shapes:V}=v(E(q,A),E(q,A));return`${V.join("-")}/${J.map((K)=>K.join("")).join("-")}`},l=function({board:q,shapes:A}){const J=[],V={tiles:q.map((L)=>L.map((U)=>U==="."?"x":".")),x:0,y:0},K=h(q),Z=p().width;let Q;const _=r({shapes:A,board:q}),$=[V,..._],O=()=>{Q=void 0,document.querySelectorAll(".active").forEach((L)=>L.classList.remove("active"))},H=(L)=>{const U=(C)=>{const M=d(C,$);C.classList.toggle("illegal",M)};document.querySelectorAll(".illegal").forEach(U),U(L)};K.addEventListener("mousedown",(L)=>{L.preventDefault()}),J.push(P(document,"mouseup",(L)=>{if(Q&&!Q.moved)Q.shape.rotateRight(L.clientX,L.clientY,Z),H(Q.shape);if(O(),i(V,_))G.classList.add("win")})),J.push(P(document,"mousemove",(L)=>{if(L.preventDefault(),!Q)return;const U=K.getBoundingClientRect(),C=Math.round((L.clientX+Q.offsetX-U.x)/Z),M=Math.round((L.clientY+Q.offsetY-U.y)/Z);if(C!==Q.shape.x||M!==Q.shape.y)Q.moved=!0,Q.shape.move(C,M),H(Q.shape)})),J.push(P(document,"mousedown",(L)=>{const U=L.target?.closest("game-block"),C=U?.closest("game-shape");if(!U||!(C instanceof z))return;O();const M=C.getBoundingClientRect();C.classList.add("active"),Q={offsetX:M.x-L.clientX,offsetY:M.y-L.clientY,moved:!1,shape:C,block:U}}));const X=document.createElement("game-header"),N=document.createElement("button");N.textContent="\u21A9 Reset",N.addEventListener("click",()=>{f(q,_),G.classList.remove("win")});const T=document.createElement("select");T.innerHTML=`
    <option value="easy">Easy</option>
    <option value="med">Medium</option>
    <option value="hard">Hard</option>
    <option value="random">Random</option>
  `,T.addEventListener("change",()=>{n(T.value)}),T.value=k;const Y=document.createElement("a");return Y.classList.add("btn-next"),Y.textContent="Next \u21AA",Y.href=`#${u()}`,X.append(N,T,Y),K.append(..._),G.classList.remove("win"),G.replaceChildren(X,K),{dispose(){J.forEach((L)=>L())}}},s=function(){let q;const A=()=>{let J=location.hash.slice(1)||u();if(!location.hash)location.replace("#"+J);const[V,K]=J.split("/");q?.dispose(),console.log(K.replaceAll("-","\n")),q=l({shapes:V.split("-").map((Z)=>parseInt(Z)),board:K.split("-").map((Z)=>Z.split(""))})};P(window,"hashchange",A),A()},B={easy:()=>[4,6],med:()=>[6,7],hard:()=>[6,9],random:()=>{const q=Math.random();return q<0.33?B.easy():q<0.66?B.med():B.hard()}},k=localStorage.getItem("blockfit.mode")||"easy",G=document.querySelector("main");class z extends HTMLElement{tiles;index;#q=0;#A=0;get x(){return this.#q}set x(q){this.#q=q,this.style.setProperty("--x",`${q}`)}get y(){return this.#A}set y(q){this.#A=q,this.style.setProperty("--y",`${q}`)}constructor(q){super();this.index=q,this.className=`block-${q}`,this.tiles=W[q].tiles,this.tiles.forEach((A)=>A.forEach((J)=>{if(J!==".")this.append(document.createElement("game-block"))})),this.rerrange()}rerrange(){let q=0;for(let A=0;A<this.tiles.length;++A){const J=this.tiles[A];for(let V=0;V<J.length;++V){if(J[V]===".")continue;const K=this.children[q];K.style.setProperty("--x",`${V}`),K.style.setProperty("--y",`${A}`),++q}}}move(q,A){this.x=q,this.y=A}rotateRight(q,A,J){this.tiles=I(this.tiles),this.rerrange();const V=Array.from(this.children).map((Q)=>{const _=Q.getBoundingClientRect();return{deltaX:_.x-q,deltaY:_.y-A}}).reduce((Q,_)=>Math.max(Q.deltaX,Q.deltaY)<Math.max(_.deltaX,_.deltaY)?Q:_),K=this.x-Math.ceil(V.deltaX/J),Z=this.y-Math.ceil(V.deltaY/J);this.move(K,Z)}}customElements.define("game-shape",z);s();
