function U(){let n=!1;const A={onKeydown:void 0,destroy(){n=!0}},L={};function K(N,u,E){if(!A.onKeydown)return;const j=L[E];if(!N.buttons[u].pressed){L[E]=void 0;return}const D=Date.now();if(!j||D-j.date>(j?.delay?175:100))L[E]={date:D,delay:!j},A.onKeydown(E)}function g(){const N=navigator.getGamepads().find((u)=>u?.connected);if(!n)window.requestAnimationFrame(g);if(!N||!A.onKeydown)return;K(N,12,"up"),K(N,13,"down"),K(N,14,"left"),K(N,15,"right"),K(N,0,"bd"),K(N,2,"bl"),K(N,1,"br"),K(N,2,"bl")}return window.requestAnimationFrame(g),A}var W=function(n){return typeof n==="string"?document.createTextNode(n):n};function O(n,A,...L){const[K,...g]=n.split("."),N=document.createElement(K||"div");if(N.className=g.join(" "),A instanceof HTMLElement||typeof A==="string")N.append(W(A));else if(A)for(let u in A){const E=A[u];if(typeof E==="function")N[u]=E;else N.setAttribute(u,E)}for(let u of L)if(u)N.appendChild(W(u));return N}var B=function(){return{moves:[],index:-1}},C=function(n,A){n.moves.splice(n.index+1,n.moves.length,A),n.index=n.moves.length-1},X=function(n){const A=n.moves[n.index];return n.index=Math.max(0,n.index-1),A?.undo},Y=function(n){return n.index=Math.min(n.index+1,n.moves.length-1),n.moves[n.index]?.redo},J=function({type:n,x:A,y:L}){const K=O("game-tile",{class:n,"data-type":n});return K.x=A,K.y=L,K},b=function(n){const L=n.split(";").flatMap((u,E)=>{return u.split("-").flatMap((j,R)=>{return j.split("").map((D)=>{return{type:I[D]||"",x:R,y:E}})})}).filter((u)=>!!u.type).flatMap((u)=>{if(u.type==="floor")return J(u);return[J(u),J({...u,type:"floor"})]}),K={tiles:L,width:0,height:0},g=L.filter((u)=>u.type==="floor"),N=g.reduce((u,E)=>{return u[`${E.x},${E.y}`]=E,u},{});return g.forEach((u)=>{const E=N[`${u.x-1},${u.y}`],j=N[`${u.x+1},${u.y}`],R=N[`${u.x},${u.y-1}`],D=N[`${u.x},${u.y+1}`];if(!R&&!j)u.classList.add("r-tr");if(!R&&!E)u.classList.add("r-tl");if(!D&&!E)u.classList.add("r-bl");if(!D&&!j)u.classList.add("r-br")}),L.reduce((u,E)=>{return u.width=Math.max(u.width,E.x),u.height=Math.max(u.height,E.y),u},K)},M=function(n){const A=n.querySelectorAll("game-tile:not(.blank)");let L=[];A.forEach((g)=>{const N=L[g.y]||[];L[g.y]=N,N[g.x]=(N[g.x]||"")+_[g.type]}),L=L.filter((g)=>g.length);const K=L.reduce((g,N)=>{const[u]=Object.keys(N);return Math.min(g,parseInt(u))},100);return L.map((g)=>g.slice(K).join("-")).join(";")},y=function(n){H.innerHTML="";const A=10,L=20,K={onmousedown(f){document.querySelectorAll(".selected").forEach((q)=>q.classList.remove("selected")),f.target.classList.add("selected")}},g=(f)=>{f.target.href="#play="+M(E)},N=O("a.next-link",{href:"#",onmouseover:g,onfocus:g},O("span","Play It"),O("b","\u279C")),u=O("game-editor",O("game-editor-header",N),O("game-editor-workspace",O("game-editor-palette",O("game-tile.player",{...K,"data-type":"player"}),O("game-tile.barrel",{...K,"data-type":"barrel"}),O("game-tile.goal",{...K,"data-type":"goal"}),O("game-tile.floor.selected",{...K,"data-type":"floor"})),O("game-editor-board",{}))),E=u.querySelector("game-editor-board");E.style.setProperty("--width",A.toString()),E.style.setProperty("--height",L.toString());const j=()=>{return u.querySelector(".selected")},R=(f)=>{if(!(f instanceof $))return;const q=j(),S=Array.from(E.querySelectorAll("game-tile")).find((P)=>{return P.type===q.type&&P.x===f.x&&P.y===f.y});if(S)S.remove();else E.append(J({type:q.type,y:f.y,x:f.x}))},D=(f)=>{R(f.target)};for(let f=0;f<L;++f)for(let q=0;q<A;++q)E.append(J({type:"blank",x:q,y:f}));E.addEventListener("mousedown",D),E.append(...n.tiles),H.append(u)},k=function(n,A,L){H.innerHTML="";const K=O("game-board");K.style.setProperty("--width",n.width.toString()),K.style.setProperty("--height",n.height.toString()),K.append(...n.tiles);const g=K.querySelector(".player");H.append(K);const N=B();function u(){const f=A+1,q=isNaN(f)||f>=G.length;H.append(O("win-modal",O("win-modal-body",O("b.icon.win-icon","\uD83D\uDC25"),q&&O("p","You won it all!"),O("a.next-link",{href:q?"#edit=":`#play=${A+1}`},O("span",q?"Make Your Own Level":"Next Level"),O("b","\u279C"))))),H.querySelector(".next-link")?.focus()}function E(){const f=(P)=>`${P.x},${P.y}`,q=new Set(n.tiles.filter((P)=>P.type==="barrel").map(f));if(n.tiles.filter((P)=>P.type==="goal").every((P)=>q.has(f(P))))u()}function j(f,q){const S=q==="left"?-1:q==="right"?1:0,P=q==="up"?-1:q==="down"?1:0,V=parseInt(f.style.getPropertyValue("--x"))+S,Z=parseInt(f.style.getPropertyValue("--y"))+P,w=n.tiles.find((F)=>{return F.type==="floor"&&F.x===V&&F.y===Z});if(f.direction=q,!w)return;const Q=n.tiles.find((F)=>{return F.type==="barrel"&&F.x===V&&F.y===Z});if(Q&&f.type!=="player")return;const p=Q&&j(Q,q);if(Q&&!p)return;if(f.type==="player")E();return{direction:q,x:V,y:Z,tile:f,next:p}}function R(f){while(f)f.tile.direction=f.direction,f.tile.x=f.x,f.tile.y=f.y,f=f.next}function D(f){const q=g.getMove(),S=j(g,f);if(!S)return;if(S.next)q.next=S.next.tile.getMove();R(S),C(N,{undo:q,redo:S}),E()}L.onKeydown=(f)=>{switch(f){case"up":case"down":case"left":case"right":return D(f);case"bl":return R(X(N));case"bd":return R(Y(N));case"br":document.querySelector(".next-link")?.click()}},K.addEventListener("keydown",(f)=>{switch(f.key){case"ArrowUp":case"k":return D("up");case"ArrowDown":case"j":return D("down");case"ArrowLeft":case"h":return D("left");case"ArrowRight":case"l":return D("right");case"u":case"z":return R(X(N));case"r":return R(Y(N))}})},G=["--.g;--.;--.b-.-.b-.g;.g-.-.b-.p;---.b;---.g",".-.-.;.-.b-.p;.-.b-.b----.g;--.----.g;--.-.-.-.-.g;-.-.-.--.-.;-.-.-.","-.-.;.-.p-.b;-.b-.;-.-.b-.;.g-.b-.-.;.g-.g-.gb-.g","-.p.-.;-.-.b.-.-.;--.--.;.g.--.--.-.;.g.-.b.-.-.--.;.g.-.-.-.-.b.-.","--.-.-.-.;--.b-.b-.b-.;.p-.-.b-.g-.g-.;.-.b-.g-.g-.g;---.","--.-.-.p;.-.-.b-.g-.;.-.-.g-.b-.g-.;--.-.gb-.b-.;--.-.-.","--.g-.g;--.-.g;-.-.-.b-.g;-.-.b-.-.;.-.--.b-.b-.;.-.p-.-.-.-.",".-.--.-.-.;.-.b-.g-.g-.b-.;.p-.b-.g-.gb-.;.-.b-.g-.g-.b-.;.-.--.-.-.",".-.-.-.;.-.b-.b-.b;.-.--.g-.g;-.-.-.g-.g-.b-.;-.-.p-.-.-.-.",".g-.g-.b-.g-.g;.g-.g--.g-.g;.-.b-.b-.b-.;.-.-.b-.-.;.-.b-.b-.b-.;.-.--.p-.","-.-.p-.;-.--.b-.-.;.-.gb-.g-.-.g-.;.-.-.b-.b-.;--.--.g;--.-.-.",".-.-.-.;.-.b-.-.p;-.bg-.-.;.-.gb-.;.-.gb-.;.-.gb-.;.-.g-.","--.-.;--.b-.;.-.-.gb-.-.p;.-.-.gb-.-.;.-.-.gb-.;--.gb-.;--.g",".-.-.;.--.--.-.-.;.-.b-.-.-.-.b-.;.g-.g--.b--.b;.g-.p-.b-.-.-.;.g-.g-.-.","-.-.-.-.;-.g---.b-.;.-.g-.g-.b-.-.;.-.--.b-.-.;.-.-.p-."],H=document.querySelector("main"),z=["left","down","right","up"];class T extends HTMLElement{onDisconnect;constructor(){super()}connectedCallback(){const n=this.querySelector(".player");let A;async function L(){await new Promise((g)=>setTimeout(g,Math.random()*3000+500)),n.classList.add("blink"),await new Promise((g)=>setTimeout(g,100)),n.classList.remove("blink"),setTimeout(L)}L();const K=(g)=>{this.dispatchEvent(new KeyboardEvent("keydown",{key:g.key}))};document.addEventListener("keydown",K),this.onDisconnect=()=>{clearTimeout(A),document.removeEventListener("keydown",K)}}disconnectedCallback(){this.onDisconnect?.()}}customElements.define("game-board",T);class $ extends HTMLElement{_x=0;_y=0;_direction="left";get x(){return this._x}set x(n){this._x=n,this.style.setProperty("--x",n.toString())}get y(){return this._y}set y(n){this._y=n,this.style.setProperty("--y",n.toString())}get direction(){return this._direction}set direction(n){this._direction=n,this.classList.remove(...z),this.classList.add(n)}get type(){return this.dataset.type||""}set type(n){this.dataset.type=n}constructor(){super()}getMove(){return{tile:this,x:this.x,y:this.y,direction:this.direction}}}customElements.define("game-tile",$);var _={player:"p",barrel:"b",goal:"g",floor:"."},I=Object.keys(_).reduce((n,A)=>{return n[_[A]]=A,n},{});(function n(){const A=U(),L=()=>{const K=location.hash.slice(1),[g="play",N="0"]=K.split("="),u=parseInt(N,10),E=isNaN(u)?N:G[u],j=b(E||"");if(g==="edit")y(j);else k(j,u,A)};L(),window.addEventListener("hashchange",L)})();
